.deploy-template:
  stage: deploy
  image: debian:12-slim

  before_script:
    - apt-get update -qq
    - apt-get install -y openssh-client
    - eval "$(ssh-agent -s)"

    # MÃ©thode qui ignore les problÃ¨mes de formatage
    - cat "$SSH_PRIVATE_KEY" | ssh-add -

    # Configuration SSH
    - mkdir -p ~/.ssh
    - ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null
    - chmod 644 ~/.ssh/known_hosts

    # Test de connexion
    - ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "echo 'âœ… Connexion SSH rÃ©ussie'"

  script:
    - echo "ðŸš€ DÃ©ploiement de $SERVICE avec profil $PROFILE"
    - |
      ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" << ENDSSH
        set -e
        cd "$DEPLOY_DIR"

        echo "ðŸ” Connexion au registry..."
        echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"

        echo "ðŸ“¥ Pull des images du profil $PROFILE..."
        docker compose --profile $PROFILE pull

        echo "ðŸ”„ Restart des services du profil $PROFILE..."
        docker compose --profile $PROFILE up -d

        echo "ðŸ§¹ Nettoyage..."
        docker image prune -af --filter "until=24h"

        echo "âœ… VÃ©rification..."
        sleep 5
        docker compose --profile $PROFILE ps

        echo "ðŸŽ‰ DÃ©ploiement du profil $PROFILE rÃ©ussi!"
      ENDSSH

  environment:
    name: production
    url: $APP_URL
