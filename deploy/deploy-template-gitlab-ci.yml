.deploy-template:
  stage: deploy
  image: debian:12-slim

  before_script:
    - apt-get update -qq
    - apt-get install -y openssh-client file
    - eval "$(ssh-agent -s)"

    # === DEBUG ===
    - echo "=== DIAGNOSTIC CLÃ‰ SSH ==="
    - echo "Type de SSH_PRIVATE_KEY:"
    - file "$SSH_PRIVATE_KEY" || echo "Pas un fichier"

    - echo "PremiÃ¨re ligne:"
    - head -1 "$SSH_PRIVATE_KEY"

    - echo "DerniÃ¨re ligne:"
    - tail -1 "$SSH_PRIVATE_KEY"

    - echo "Nombre de lignes:"
    - wc -l "$SSH_PRIVATE_KEY"

    - echo "Permissions:"
    - ls -la "$SSH_PRIVATE_KEY"
    # === FIN DEBUG ===

    - chmod 600 "$SSH_PRIVATE_KEY"
    - ssh-add -v "$SSH_PRIVATE_KEY"

    # Nettoyage (sÃ©curitÃ©)
    - rm "$SSH_PRIVATE_KEY"

    # Configuration du known_hosts
    - ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null
    - chmod 644 ~/.ssh/known_hosts

    # Test de connexion
    - ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "echo 'âœ… Connexion SSH rÃ©ussie'"

  script:
    - echo "ðŸš€ DÃ©ploiement vers $APP_URL"

    - |
      ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" << 'ENDSSH'
        set -e
        cd "$DEPLOY_DIR"

        echo "ðŸ” Connexion au registry..."
        echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"

        echo "ðŸ“¥ Pull des images..."
        docker compose --env-file .env.prod pull $SERVICE

        echo "ðŸ”„ RedÃ©marrage..."
        docker compose --env-file .env.prod up -d $SERVICE

        echo "ðŸ§¹ Nettoyage..."
        docker image prune -af --filter "until=24h"

        echo "âœ… VÃ©rification..."
        sleep 5
        docker compose ps
      ENDSSH

    - echo "ðŸŽ‰ DÃ©ploiement rÃ©ussi!"

  environment:
    name: production
    url: $APP_URL
