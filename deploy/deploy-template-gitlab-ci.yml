.deploy-template:
  stage: deploy
  image: debian:12-slim

  before_script:
    - apt-get update -qq
    - apt-get install -y openssh-client
    - eval "$(ssh-agent -s)"

    # MÃ©thode qui ignore les problÃ¨mes de formatage
    - cat "$SSH_PRIVATE_KEY" | ssh-add -

    # Configuration SSH
    - mkdir -p ~/.ssh
    - ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null
    - chmod 644 ~/.ssh/known_hosts

    # Test de connexion
    - ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "echo 'âœ… Connexion SSH rÃ©ussie'"

  script:
    - echo "ðŸš€ DÃ©ploiement vers $APP_URL"

    - |
      ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" << 'ENDSSH'
        set -e
        cd "$DEPLOY_DIR"

        echo "ðŸ” Connexion au registry..."
        echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"

        echo "ðŸ“¥ Pull des images..."
        docker compose --env-file .env.prod pull $SERVICE

        echo "ðŸ”„ RedÃ©marrage..."
        docker compose --env-file .env.prod up -d $SERVICE

        echo "ðŸ§¹ Nettoyage..."
        docker image prune -af --filter "until=24h"

        echo "âœ… VÃ©rification..."
        sleep 5
        docker compose ps
      ENDSSH

    - echo "ðŸŽ‰ DÃ©ploiement rÃ©ussi!"

  environment:
    name: production
    url: $APP_URL
