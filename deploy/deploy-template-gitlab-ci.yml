.deploy-template:
  stage: deploy
  image: debian:12-slim

  before_script:
    - apt-get update
    - apt-get install -y openssh-client
    - eval "$(ssh-agent -s)"
    - ssh-add "$SSH_PRIVATE_KEY"
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

  script:
    - echo "ðŸš€ DÃ©ploiement automatique vers PRODUCTION"
    - echo "Serveur $SSH_HOST"
    - echo "RÃ©pertoire $DEPLOY_DIR"
    - echo "URL $APP_URL"
    - echo "Version $IMAGE_TAG"

    - |
      ssh $SSH_USER@$SSH_HOST << EOF
        cd "$DEPLOY_DIR"

        echo "Connexion au registry GitLab..."
        echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"

        echo "RÃ©cupÃ©ration des nouvelles images..."
        docker compose --env-file .env.prod pull $SERVICE

        echo "Rechargement de l'application..."
        docker compose --env-file .env.prod up -d $SERVICE

        echo "Nettoyage des anciennes images..."
        docker image prune -af --filter "until=24h"

        echo "VÃ©rification des services..."
        sleep 5
        docker compose ps
      EOF

    - echo "ðŸŽ‰ DÃ©ploiement rÃ©ussi sur $APP_URL"
  environment:
    name: production
    url: $APP_URL
